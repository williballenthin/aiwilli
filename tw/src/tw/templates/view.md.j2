# {{ issue.id }}: {{ issue.title }}
{% if issue.status.value == 'stopped' %}
{% set handoff = issue.annotations | selectattr('type.value', 'equalto', 'handoff') | list | last %}
{% if handoff %}

> **HANDOFF:** {{ handoff.message }}
{% endif %}
{% endif %}

{% set props = [issue.type.value, issue.status.value] %}
{% if issue.parent %}{% set props = props + ['parent: ' + issue.parent] %}{% endif %}
{% if issue.refs %}{% set props = props + ['refs: ' + issue.refs|join(', ')] %}{% endif %}
*{{ props | join(' | ') }}*

{% if issue.body %}
## Body

{{ issue.body }}
{% endif %}
{% if issue.annotations %}
{% set visible_annotations = issue.annotations | rejectattr('type.value', 'in', ['work-begin', 'work-end']) | selectattr('message') | list %}
{% if visible_annotations %}

## Annotations

{% for annotation in visible_annotations %}
{% set first_line = annotation.message.split('\n')[0].strip() %}
{% if first_line %}
- [{{ annotation.type.value }}] {{ annotation.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}: {{ first_line }}
{% endif %}
{% endfor %}
{% endif %}
{% endif %}

{% if ancestors %}
## Ancestors

{% for ancestor in ancestors | reverse %}
### {{ ancestor.id }}: {{ ancestor.title }}

**Type:** {{ ancestor.type.value }} | **Status:** {{ ancestor.status.value }}
{% if ancestor.body %}
{% if '---' in ancestor.body %}
{{ ancestor.body.split('---')[0].strip() }}
{% else %}
{{ ancestor.body }}
{% endif %}
{% endif %}
{% endfor %}
{% endif %}

{% if siblings %}
## Siblings

{% for sibling in siblings %}
{{ sibling|render_tree_line(0) }}
{% endfor %}
{% endif %}

{% set completed_siblings = siblings | selectattr('status.value', 'equalto', 'done') | list %}
{% set sibling_lessons = [] %}
{% for sibling in completed_siblings %}
{% if sibling.annotations %}
{% set lessons = sibling.annotations | selectattr('type.value', 'in', ['lesson', 'deviation']) | list %}
{% if lessons %}
{% set _ = sibling_lessons.append({'sibling': sibling, 'lessons': lessons}) %}
{% endif %}
{% endif %}
{% endfor %}
{% if sibling_lessons %}

## Lessons from Siblings

{% for item in sibling_lessons %}
**{{ item.sibling.id }}** ({{ item.sibling.title | truncate(40) }}):
{% for lesson in item.lessons %}
- [{{ lesson.type.value }}] {{ lesson.message.split('\n')[0] }}
{% endfor %}

{% endfor %}
{% endif %}

{% if descendants %}
## Descendants

{% for descendant in descendants %}
{{ descendant|render_tree_line(0) }}
{% endfor %}
{% endif %}

{% if referenced %}
## Referenced Issues

{% for ref in referenced %}
{{ ref|render_tree_line(0) }}
{% endfor %}
{% endif %}

{% if referencing %}
## Issues Referencing This

{% for ref in referencing %}
{{ ref|render_tree_line(0) }}
{% endfor %}
{% endif %}
