# tw - TaskWarrior-backed Issue Tracker for AI Agents

## Overview

`tw` is a command-line issue tracker built on TaskWarrior v3, optimized for LLM-based software engineering agents. It solves two primary problems:

1. **Quick capture** — Easily record tasks, ideas, and bugs while agents work
2. **Context persistence** — Combat agent context rot by providing structured handoffs and hierarchical context assembly

Inspired by [Beads](https://github.com/steveyegge/beads), but leveraging TaskWarrior as the backend instead of reinventing an issue tracker.

## Data Model

### TaskWarrior UDAs

| UDA | Type | Description |
|-----|------|-------------|
| `tw_type` | string | `epic`, `story`, or `task` |
| `tw_parent` | string | `tw_id` of parent (e.g., `PROJ-1-2`), empty for orphans/epics |
| `tw_id` | string | Human-readable ID like `PROJ-1-2a` |
| `tw_body` | string | Markdown: repeatable section + `---` + details |
| `tw_refs` | string | Comma-separated referenced `tw_id` values, sorted |
| `tw_status` | string | `new`, `in_progress`, `stopped`, `blocked`, `done` |

### Standard TaskWarrior Fields

- `description` — Issue title
- `project` — From `TW_PROJECT_NAME` / `PROJECT_NAME` / `"default"`
- `status` — Only flips to `completed` when `tw_status` is `done`
- `annotations` — Timestamped `[type] message` entries

### Annotation Types

- `[work-begin]` — Started work
- `[work-end]` — Completed work
- `[lesson]` — Lesson learned
- `[deviation]` — Deviation from plan
- `[commit]` — VCS reference
- `[handoff]` — Structured handoff summary
- `[blocked]` — Blocked with reason
- `[unblocked]` — Unblocked with reason
- `[comment]` — General note

### ID Generation

- **Epics:** `PREFIX-N` (next available integer)
- **Stories:** `EPIC-N` (next under parent, or reserves epic slot if orphan)
- **Tasks:** `STORY-x` (a-z, aa-zz suffix; reserves parent slots if orphan)

Project prefix comes from: `--project-prefix`, `TW_PROJECT_PREFIX`, `PROJECT_PREFIX`, or `"default"`

**Reserved slots are permanent** — parent is immutable after creation.

### Body Structure

Single `---` separator:
- Content before `---` is **repeatable** (included in context views)
- Content after `---` is **non-repeatable** (only for target issue)

```markdown
This is the repeatable context (summary).
---
This is the non-repeatable deep dive with implementation details...
```

## State Machine

```
                    ┌─────────────────────────┐
                    │                         │
                    ▼                         │
┌───────┐      ┌─────────────┐      ┌─────────┴─┐
│  new  │─────▶│ in_progress │─────▶│  stopped  │
└───────┘      └─────────────┘      └───────────┘
   │                │    ▲
   │                ▼    │
   │           ┌─────────┴─┐
   │           │  blocked  │
   │           └───────────┘
   │                │
   └───────────────▶│
                    ▼
               ┌─────────┐
               │  done   │
               └─────────┘
```

| Command | Valid From | To |
|---------|------------|-----|
| `tw start` | `new`, `stopped` | `in_progress` |
| `tw blocked` | `in_progress` | `blocked` |
| `tw unblock` | `blocked` | `in_progress` |
| `tw handoff` | `in_progress` | `stopped` |
| `tw done` | `in_progress` | `done` |

## Commands

### Global Options

- `--project-name` / `TW_PROJECT_NAME` / `PROJECT_NAME` / `"default"`
- `--project-prefix` / `TW_PROJECT_PREFIX` / `PROJECT_PREFIX` / `"default"`
- `--json` — Emit JSON instead of human-readable output
- `--verbose` — DEBUG logging, full tracebacks
- `--quiet` — ERROR logging only

### Issue Lifecycle

| Command | Description |
|---------|-------------|
| `tw new <type> --title "..." [--parent <id>] [--body "..."]` | Create epic/story/task |
| `tw edit <id> [--title "..."] [--body "..."]` | Edit issue (or open `$EDITOR`) |
| `tw delete <id>` | Delete issue (error if has children) |
| `tw capture [-]` | Bulk create from indented DSL |

### Status Transitions

| Command | Description |
|---------|-------------|
| `tw start <id>` | Begin work → `in_progress` |
| `tw blocked <id> --reason "..."` | Mark blocked |
| `tw unblock <id> --reason "..."` | Resume after unblock |
| `tw handoff <id> --status "..." --completed "..." --remaining "..."` | Structured pause |
| `tw done <id>` | Complete work |
| `tw stop` | Error — use `tw handoff` instead |

### Recording

| Command | Description |
|---------|-------------|
| `tw record <lesson\|deviation\|commit> --message "..."` | Add typed annotation |
| `tw comment <id> --message "..."` | Add comment annotation |

### Views

| Command | Description |
|---------|-------------|
| `tw view <id>` | Full context view for an issue |
| `tw digest <id>` | Parent summary with children overview |
| `tw tree` | Hierarchy of all active epics/stories/tasks |
| `tw onboard` | Print quickstart for SWE agents |

## Context Assembly (`tw view`)

| Source | What's Included |
|--------|-----------------|
| **Self** | Full title, full body, all annotations |
| **Ancestors** (up to root) | ID + Title + Status + Repeatable body |
| **Descendants** (direct children) | ID + Title + Status + Repeatable body |
| **Siblings** | ID + Title + Status + Repeatable body |
| **References** | ID + Title only |

If `tw_status` is `stopped`, display the most recent `[handoff]` annotation prominently at the top.

## Output Formats

### `tw tree`

```
epic: User Authentication (PROJ-1) [in_progress]
  story: Login Flow (PROJ-1-1) [done]
    task: Create login form (PROJ-1-1a) [done]
    task: Add validation (PROJ-1-1b) [done]
  story: Session Management (PROJ-1-2) [in_progress]
    task: Implement JWT tokens (PROJ-1-2a) [in_progress]
    task: Add refresh logic (PROJ-1-2b) [new]
```

**Styling:**
- `[done]` — Muted/dim
- `[in_progress]` — Yellow
- `[blocked]` — Red
- `[stopped]` — Cyan (with handoff shown)
- `[new]` — Default

**Filtering:** Hide epics where epic AND all descendants are `done`.

### `tw capture` DSL

```
- epic: User Authentication
  - story: Login Flow
    - task: Create login form
# comments starting with # are ignored
```

### Editor Template

```
<title>
# tw: Enter the issue title on the first line above
---
<repeatable summary>
# tw: Enter a brief summary above the separator
---
<detailed description>
# tw: Lines starting with '# tw:' will be ignored
```

## ID Sorting Algorithm

IDs sort correctly: `PROJ-1`, `PROJ-1-1`, `PROJ-1-1a`, `PROJ-1-2`, `PROJ-1-10`, `PROJ-2`, `PROJ-12`

```python
def parse_id_key(tw_id: str) -> tuple:
    parts = tw_id.split("-")[1:]
    result = []
    for part in parts:
        if part.isdigit():
            result.append((0, int(part), ""))
        else:
            result.append((1, 0, part))
    return tuple(result)
```

## Error Handling

**Format** (stdout, non-verbose):
```
error: issue PROJ-99 not found
error: cannot start PROJ-1-1a: already in_progress
error: cannot delete PROJ-1: has 3 children
```

**Warnings** (stderr, non-fatal):
```
warning: closing PROJ-1-2 while child PROJ-1-2a is still in_progress
```

## Architecture

### Stack

- **Python** with type hints
- **Click** — CLI parsing
- **Pydantic** — JSON serialization
- **dataclasses** — Internal models with `@classmethod from_foo()` constructors
- **Rich** — Terminal output, syntax highlighting, spinners
- **Jinja** — Human-readable templates
- **pytest** — Testing (no mocks, session-scoped fixtures)
- **ruff** — Formatting and linting
- **mypy** — Type checking

### Conventions

- Global logger per file: `logger = logging.getLogger(__name__)`
- Pass explicit `rich.Console` to print routines; stderr console for spinners/logging
- `pathlib.Path` for filesystem paths
- Raise exceptions, not `None` or sentinels
- Function naming: `get_*`, `validate_*`, `render_*`, `output_*`

### TaskWarrior Abstraction

- All interaction via `task export` (read) and `task import` (write)
- Localized helpers, named generically for future backend swap

### Testing

- Write tests before implementing
- No mocks — layer for testability
- Close to 100% coverage
- Fast suite with session-scoped fixtures

## Deferred Features

- `tw scan` — Parse codebase for `TODO(tw):` comments
- `tw onboard` example sessions
- LLM-powered `tw digest` summarization
